parameters:
  dependsOn: ''
  conditions: ''
phases:
  - phase: Push to B.A.R.
    dependsOn: ${{ parameters.dependsOn }}
    queue:
      name: DotNetCore-Build
      demands:
        - agent.os -equals Windows_NT        
    steps:
    - ${{ if and( startsWith(parameters.conditions, 'not'), not(contains(parameters.conditions, variables['build.reason']))) }}:
        - task: DownloadBuildArtifacts@0
          displayName: Download artifact
          inputs:
            artifactName: AssetManifests    
            downloadPath: '$(Build.StagingDirectory)/Download'
          condition: succeeded()
        - task: AzureKeyVault@1
          inputs:
            azureSubscription: 'DotNet-Engineering-Services_KeyVault'
            KeyVaultName: EngKeyVault
            SecretsFilter: 'MaestroAccessToken'
          condition: succeeded()
        - script: eng\common\pushbuildassets.cmd
            /p:ManifestZipFilePath='$(Build.StagingDirectory)/Download/AssetManifests'
            /p:BuildAssetRegistryToken=$(MaestroAccessToken)
            /p:MaestroApiEndpoint=https://maestro-int.westus2.cloudapp.azure.com
          displayName: Push Build Assets